<% if @test.complete %>
  <div class="card text-center mb-4">
    <div class="card-header">
      <h3>FHIR Import Test Results (Test ID: <%= @test.id %>)</h3>
    </div>
    <div class="card-block">
      <h4 class="card-title"><%= @test.successes['successes'].count %> out of <%= @test.successes['successes'].count + @test.problems['problems'].count %> data elements reported successfully.</h2></h4>
      <div class="container-fluid">
        <div class="row justify-content-center p-3">
          <div class="no-pad-no-marg c100 large canary-color p<%= @test.score %>">
              <span><%= @test.score %>%</span>
              <div class="slice">
                <div class="bar"></div>
                <div class="fill"></div>
              </div>
            </div>
          </div>
        </div>
      </div>
    <div class="card-footer text-muted">
      Completed <%= time_ago_in_words(@test.updated_at) %> ago.
    </div>
  </div>
  <div id="accordion" role="tablist" aria-multiselectable="true" class="container-fluid no-pad-no-marg">
    <% @test.problems['problems'].each do |problem| %>
      <div id="<%= problem['id'] %>" data-toggle="collapse" data-target="#collapse<%= problem['id'] %>" aria-expanded="true" aria-controls="collapse<%= problem['id'] %>" class="alert alert-danger alert-dismissible fade show">
        <button type="button" class="close" data-dismiss="alert" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
        <h5><i class="fa fa-times text-danger" aria-hidden="true"></i><span class="pl-2"><%= problem['description'] %></span></h5>
        Expected to find <strong><%= problem['test_value'] %></strong> but instead found <strong><%= problem['uploaded_value'] %></strong>.

      </div>
    <% end %>
    <% @test.successes['successes'].each do |success| %>
      <div id="<%= success['id'] %>" data-toggle="collapse" data-target="#collapse<%= success['id'] %>" aria-expanded="true" aria-controls="collapse<%= success['id'] %>" class="alert alert-success alert-dismissible fade show">
        <button type="button" class="close" data-dismiss="alert" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
        <h5><i class="fa fa-check text-success" aria-hidden="true"></i><span class="pl-2"><%= success['description'] %></span></h5>
        Found expected value of <strong><%= success['test_value'] %></strong>.

      </div>
    <% end %>
  </div>
  <div class="pb-4"></div>
<% else %>
  <h2>EDRS Ingestion of FHIR Data Test Procedure</h2>
  <h4>
    <ol>
      <li class="c-li">Configure your EDRS to receive FHIR patient data from the Canary Testing Framework.</li>
      <li class="c-li">Start transmitting the FHIR data to your EDRS by entering your FHIR endpoint URL below and pressing send.</li>
      <li class="c-li">After the FHIR data has been pushed to your EDRS, export the same data in IJE format.</li>
      <li class="c-li">Upload the IJE data file below to initiate Canary validation.</li>
    </ol>
  </h4>
  <br />
  <div class="container">
    <div class="row">
      <div class="col-md-6 ml-0 pl-0">
        <fieldset>
          <legend>Send FHIR Data</legend>
          <%= form_tag({action: :send_fhir, test_type: @type, system_id: params['system_id'], id: @test.id}, multipart: true) do |f| %>
            <%= text_field_tag 'endpoint', 'http://localhost:3000/fhir/v1/death_records', class: 'form-control block mb-4' %>
            <%= submit_tag "Send!", class: "btn btn-primary float-right" %>
          <% end %>
        </fieldset>
      </div>
      <div class="col-md-6 mr-0 pr-0">
        <fieldset>
          <legend>Upload IJE Data</legend>
          <%= form_tag({action: :upload, test_type: @type, system_id: params['system_id'], id: @test.id}, multipart: true) do |f| %>
            <%= file_field_tag 'ije', required: true, class: 'form-control block mb-4' %>
            <%= submit_tag "Upload!", class: "btn btn-primary float-right" %>
          <% end %>
        </fieldset>
      </div>
    </div>
  </div>
<% end %>


